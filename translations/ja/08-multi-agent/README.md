[![マルチエージェント設計](../../../translated_images/ja/lesson-8-thumbnail.278a3e4a59137d62.webp)](https://youtu.be/V6HpE9hZEx0?si=A7K44uMCqgvLQVCa)

> _(上の画像をクリックするとこのレッスンのビデオが表示されます)_

# マルチエージェント設計パターン

複数のエージェントを含むプロジェクトに取り組み始めると、マルチエージェント設計パターンを考慮する必要があります。しかし、いつマルチエージェントに切り替えるべきか、その利点は何かはすぐには明確でないかもしれません。

## はじめに

このレッスンでは、以下の疑問に答えることを目指します：

- マルチエージェントが適用できるシナリオは何か？
- 複数のタスクを一人の単一エージェントが行うよりも、マルチエージェントを使う利点は何か？
- マルチエージェント設計パターンを実装するための構成要素は何か？
- 複数のエージェントがどう相互作用しているかをどのように可視化するか？

## 学習目標

このレッスンの後、あなたは以下ができるようになります：

- マルチエージェントが適用可能なシナリオを特定する
- 単一のエージェントよりマルチエージェントを使う利点を認識する
- マルチエージェント設計パターンの構成要素を理解する

より大きな視点は何か？

*マルチエージェントは複数のエージェントが協力して共通の目標を達成するための設計パターンです*。

このパターンは、ロボティクス、自律システム、分散コンピューティングなど様々な分野で広く使われています。

## マルチエージェントが適用されるシナリオ

では、どんなシナリオがマルチエージェントの良い利用ケースなのでしょうか？答えは、以下の場合をはじめ、複数のエージェントを使うことが有益なシナリオが多くあります：

- **大規模な作業負荷**：大きな作業は小さいタスクに分割して異なるエージェントに割り当てることができ、並列処理とより速い完了を可能にします。例としては大規模なデータ処理タスクが挙げられます。
- **複雑なタスク**：大きい作業負荷と同様に、複雑なタスクは小さなサブタスクに分割して、それぞれ特定のタスクに特化したエージェントに割り当てられます。自動運転車の場合では、異なるエージェントがナビゲーション、障害物検知、他車両との通信を担当する良い例です。
- **多様な専門知識**：異なるエージェントが多様な専門知識を持つことで、単一エージェントよりも効果的にタスクの異なる側面を処理できます。この場合、医療分野でエージェントが診断、治療計画、患者モニタリングを管理する例が良い例です。

## 単一エージェントよりマルチエージェントの利点

単一エージェントシステムは単純なタスクにはうまく機能しますが、より複雑なタスクでは複数のエージェントを使うことでいくつかの利点があります：

- **専門化**：各エージェントは特定のタスクに専門化できます。単一エージェントで専門化がない場合、エージェントはすべてを行えますが、複雑なタスクに直面した時に何をすべきか混乱する可能性があります。例えば、最適でないタスクを行ってしまうこともありえます。
- **拡張性**：一つのエージェントに負荷をかけるよりも、より多くのエージェントを追加する方がシステムの拡張が簡単です。
- **障害許容性**：一つのエージェントが故障しても他のエージェントが機能を続け、システムの信頼性を保証します。

例として、ユーザーの旅行予約を考えてみましょう。単一エージェントシステムなら、フライト検索からホテルやレンタカー予約まで旅行予約のすべての側面を扱う必要があります。単一エージェントでこれを実現するには、すべてのタスクを処理できるツールが必要で、結果として保守と拡張が難しい複雑でモノリシックなシステムになる可能性があります。一方でマルチエージェントシステムなら、フライト検索、ホテル予約、レンタカー予約に特化した異なるエージェントを持つことができ、モジュール化され保守しやすく、拡張も容易になります。

これを個人経営の旅行代理店とフランチャイズの旅行代理店と比較してみましょう。個人経営店では単一エージェントがすべての旅行予約の側面を扱うのに対し、フランチャイズ店では異なるエージェントが異なる予約処理を担当します。

## マルチエージェント設計パターンの構成要素

マルチエージェント設計パターンを実装する前に、パターンを構成する要素を理解する必要があります。

もう一度ユーザーの旅行予約の例で具体化しましょう。この場合、構成要素には以下が含まれます：

- **エージェント間通信**：フライト検索、ホテル予約、レンタカー予約のエージェントは、ユーザーの好みや制約に関する情報を共有し通信する必要があります。具体的には、フライト検索エージェントがホテル予約エージェントに、ホテルがフライトと同じ日程で予約されていることを確認するために通信します。つまり、どのエージェントが情報を共有し、どのように共有するのかを決める必要があります。
- **調整メカニズム**：エージェントはユーザーの好みと制約を満たすために行動を調整しなければなりません。例えば、ユーザーの好みが空港近くのホテルを希望することで、一方でレンタカーは空港でのみ利用可能という制約があるかもしれません。これにより、ホテル予約エージェントはレンタカー予約エージェントと調整し、ユーザーの好みと制約を満たす必要があります。どのようにエージェントが行動を調整するかを決める必要があります。
- **エージェントアーキテクチャ**：エージェントは意思決定し、ユーザーとの相互作用から学習するための内部構造を持つ必要があります。例えば、フライト検索エージェントはどのフライトをユーザーに推奨するか決定するための内部構造を持つ必要があります。つまり、エージェントがどのように意思決定しユーザーとのやり取りから学習するかを決める必要があります。例えば、フライト検索エージェントが過去のユーザープリファレンスに基づいて機械学習モデルを使いフライトを推奨するケースがあります。
- **マルチエージェント間相互作用の可視化**：複数のエージェントがどのように相互作用しているかを可視化する必要があります。エージェントの活動や相互作用を追跡するためのツールや技術が必要となります。ログとモニタリングツール、可視化ツール、パフォーマンス指標などの形態が考えられます。
- **マルチエージェントパターン**：集中型、分散型、ハイブリッドなど、マルチエージェントシステムの実装には異なるパターンがあります。ユースケースに最も適したパターンを決定する必要があります。
- **人間の関与**：多くの場合、人間が関与するため、エージェントがいつ人間の介入を求めるかを指示する必要があります。例えば、ユーザーがエージェントが推奨しなかった特定のホテルやフライトを希望したり、予約前に確認を求めたりする場合です。

## マルチエージェント間相互作用の可視化

複数のエージェントがどのように相互作用しているかを可視化できることが重要です。この可視化はデバッグ、最適化、システム全体の有効性の確保に不可欠です。これを達成するには、エージェントの活動や相互作用を追跡するためのツールや技術が必要です。ログとモニタリングツール、可視化ツール、パフォーマンス指標などが考えられます。

例えば、ユーザーの旅行予約では、各エージェントの状態、ユーザーの好みや制約、エージェント間の相互作用を表示するダッシュボードを持つことができます。このダッシュボードには、ユーザーの旅行日程、フライトエージェントが推奨するフライト、ホテルエージェントが推奨するホテル、レンタカーエージェントが推奨するレンタカーが表示されます。これにより、エージェントの相互作用の状況やユーザーの好みや制約の満たされ方が明確にわかります。

それぞれの側面を詳しく見てみましょう。

- **ログとモニタリングツール**：エージェントが行った各アクションについてログを取ることが望まれます。ログエントリには、アクションを行ったエージェント、取ったアクション、その時刻、結果が含まれます。この情報はデバッグや最適化に利用されます。

- **可視化ツール**：可視化ツールはエージェント間の相互作用をより直感的に見るのに役立ちます。例えば、エージェント間の情報の流れを表示するグラフが考えられ、ボトルネックや非効率、その他の問題点を特定する助けになります。

- **パフォーマンス指標**：パフォーマンス指標はマルチエージェントシステムの有効性を追跡するのに役立ちます。例えば、タスク完了にかかった時間、時間あたりに完了したタスク数、エージェントの推奨の正確さが挙げられます。これにより改善点の特定やシステムの最適化が可能になります。

## マルチエージェントパターン

マルチエージェントアプリを作るために使える具体的なパターンを見てみましょう。以下は考慮に値する興味深いパターンです：

### グループチャット

このパターンは、複数のエージェントが互いに通信できるグループチャットアプリケーションを作りたい場合に役立ちます。典型的な利用ケースはチームコラボレーション、カスタマーサポート、ソーシャルネットワーキングです。

このパターンでは、各エージェントがグループチャット内のユーザーを表し、メッセージはメッセージングプロトコルを使ってエージェント間で交換されます。エージェントはグループチャットにメッセージを送信し、受信し、他のエージェントからのメッセージに応答します。

このパターンは、すべてのメッセージが中央サーバーを経由する集中型アーキテクチャか、メッセージが直接交換される分散型アーキテクチャのいずれかで実装できます。

![Group chat](../../../translated_images/ja/multi-agent-group-chat.ec10f4cde556babd.webp)

### ハンドオフ

このパターンは、複数のエージェントがタスクを互いに引き継げるアプリケーションを作りたい場合に役立ちます。

典型的な利用ケースはカスタマーサポート、タスク管理、ワークフロー自動化です。

このパターンでは、各エージェントがタスクまたはワークフローのステップを表し、事前に定義されたルールに基づいてエージェント間でタスクを引き継ぎます。

![Hand off](../../../translated_images/ja/multi-agent-hand-off.4c5fb00ba6f8750a.webp)

### 協調フィルタリング

このパターンは、複数のエージェントが協力してユーザーに推薦を行うアプリケーションを作りたい場合に役立ちます。

なぜ複数のエージェントで協力するかというと、各エージェントが異なる専門知識を持ち、推薦過程に多様な方法で貢献できるためです。

例として、ユーザーが株式市場で買うべき最良の株を推薦してほしい場合を考えましょう。

- **業界専門家**：あるエージェントは特定の業界に対する専門知識を持ちます。
- **テクニカル分析**：別のエージェントがテクニカル分析の専門家です。
- **ファンダメンタル分析**：もう一つのエージェントがファンダメンタル分析の専門家です。これらが協力することでより包括的な推薦をユーザーに提供できます。

![Recommendation](../../../translated_images/ja/multi-agent-filtering.d959cb129dc9f608.webp)

## シナリオ：返金プロセス

製品の返金を求める顧客のシナリオを考えましょう。このプロセスには多くのエージェントが関わる可能性がありますが、返金プロセス専用のエージェントと他のプロセスでも使える一般的なエージェントに分けて考えます。

**返金プロセス専用のエージェント**：

返金プロセスに関わる可能性のあるエージェントは以下です：

- **顧客エージェント**：顧客を表し、返金プロセスの開始を担当します。
- **販売者エージェント**：販売者を表し、返金処理を担当します。
- **支払いエージェント**：支払いプロセスを表し、顧客への返金を担当します。
- **解決エージェント**：返金プロセス中に発生する問題の解決を担当します。
- **コンプライアンスエージェント**：返金プロセスが規制やポリシーに準拠しているかを確認します。

**一般的なエージェント**：

これらのエージェントはビジネスの他の部分でも使えます。

- **配送エージェント**：配送プロセスを表し、製品を販売者に返送する責任を負います。返金プロセスだけでなく購入品の一般配送にも使えます。
- **フィードバックエージェント**：顧客からのフィードバック収集を担当します。返金プロセス中だけでなくいつでも収集可能です。
- **エスカレーションエージェント**：問題をより高いサポートレベルにエスカレーションします。問題をエスカレートする必要があるあらゆるプロセスで使えます。
- **通知エージェント**：返金プロセスの各段階で顧客へ通知を送る責任を負います。
- **分析エージェント**：返金プロセスに関連するデータ分析を行います。
- **監査エージェント**：返金プロセスが正確に実行されているか監査します。
- **報告エージェント**：返金プロセスに関するレポートの作成を担当します。
- **ナレッジエージェント**：返金プロセスに関する情報のナレッジベースを維持します。このエージェントは返金以外のビジネス分野にも詳しいかもしれません。
- **セキュリティエージェント**：返金プロセスのセキュリティを確保します。
- **品質エージェント**：返金プロセスの品質を保証します。

返金プロセス専用と一般的なエージェントの両方に多数のエージェントが先に挙げられました。これにより、マルチエージェントシステムでどのエージェントを使うかを決めるためのヒントが得られるでしょう。

## 課題

カスタマーサポートプロセス用のマルチエージェントシステムを設計してください。プロセスに関わるエージェント、彼らの役割と責任、そしてどのように相互作用するかを特定してください。カスタマーサポートプロセスに特化したエージェントとビジネスの他の部分でも使える一般的なエージェントの両方を考慮してください。
> 次の解決策を読む前に少し考えてみてください。想像以上に多くのエージェントが必要になるかもしれません。

> TIP: カスタマーサポートプロセスの異なる段階について考え、システムに必要なエージェントも考慮してください。

## 解決策

[Solution](./solution/solution.md)

## 知識確認

質問: マルチエージェントを使用すべきなのはどんな時ですか？

- [ ] A1: 作業量が少なく、タスクが簡単な場合。
- [ ] A2: 作業量が多い場合。
- [ ] A3: タスクが簡単な場合。

[Solution quiz](./solution/solution-quiz.md)

## まとめ

このレッスンでは、マルチエージェントのデザインパターンについて学びました。マルチエージェントが適用されるシナリオ、単一エージェントよりもマルチエージェントを使用する利点、マルチエージェントデザインパターンを実装するための基本要素、および複数のエージェントがどのように相互作用しているかを把握する方法について紹介しました。

### マルチエージェントのデザインパターンについてさらに質問がありますか？

[Microsoft Foundry Discord](https://aka.ms/ai-agents/discord) に参加して、他の学習者と交流したり、オフィスアワーに参加したり、AIエージェントに関する質問に答えてもらいましょう。

## 追加リソース

- <a href="https://microsoft.github.io/autogen/stable/user-guide/core-user-guide/design-patterns/intro.html" target="_blank">AutoGenのデザインパターン</a>
- <a href="https://www.analyticsvidhya.com/blog/2024/10/agentic-design-patterns/" target="_blank">エージェントデザインパターン</a>

## 前のレッスン

[Planning Design](../07-planning-design/README.md)

## 次のレッスン

[Metacognition in AI Agents](../09-metacognition/README.md)

---

<!-- CO-OP TRANSLATOR DISCLAIMER START -->
**免責事項**：  
本書類はAI翻訳サービス「Co-op Translator」（https://github.com/Azure/co-op-translator）を使用して翻訳されています。正確性の確保に努めていますが、自動翻訳には誤りや不正確な表現が含まれる場合があります。原文は原言語の文書を正式な情報源としてください。重要な情報については、専門の人間による翻訳を推奨します。本翻訳の使用により生じた誤解や解釈の相違について、当方は一切責任を負いません。
<!-- CO-OP TRANSLATOR DISCLAIMER END -->